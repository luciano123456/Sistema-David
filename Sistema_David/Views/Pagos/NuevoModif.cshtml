@{
    ViewBag.Title = "Pago de Sueldo";
    var id = (int?)Model ?? null; // si venís a ver/editar
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="~/Estilos/bootstrap.min.css" rel="stylesheet" />
<link href="~/Estilos/pagosnuevomodif.css?v=3.1" rel="stylesheet" />

<style>
    /* Lightbox simple para previsualización de comprobante (imágenes) */
    #imgLightbox {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1085;
    }

        #imgLightbox img {
            max-width: 92vw;
            max-height: 92vh;
            box-shadow: 0 20px 60px rgba(0,0,0,.6);
            border-radius: 10px;
        }

        #imgLightbox .close {
            position: absolute;
            top: 18px;
            right: 22px;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
        }

    #comprobanteLink {
        display: inline-block;
        margin-top: .5rem;
    }
</style>

<div class="container pay-nm">
    <div class="page-bg"></div>
    <div class="page-grid"></div>

    <!-- TOPBAR -->
    <div class="topbar d-flex align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
            <div class="badge-chip">
                <i class="bi bi-shield-check"></i>
                <span>@(id.HasValue ? "Edición" : "Nuevo")</span>
            </div>
            <div>
                <h1 class="title">Pago de Sueldo</h1>
                <div class="subtitle">Liquidación de comisiones y registro de pagos</div>
            </div>
        </div>
        <div class="actions d-flex flex-wrap gap-2">
            <a class="btn btn-ghost" href="~/Pagos/Index"><i class="bi bi-arrow-left-short me-1"></i>Volver</a>
            <button id="btnExportPdf" class="btn btn-success-soft"><i class="bi bi-filetype-pdf me-1"></i>Exportar PDF</button>
            <button id="btnOpenReglas" class="btn btn-slate"><i class="bi bi-sliders2-vertical me-1"></i>Reglas</button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="kpis row g-3 mb-3">
        <div class="col-12 col-md-4">
            <div class="info-box">
                <div class="info-label">Importe</div>
                <div class="info-value" id="sumTotal">$ 0,00</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="info-box info-ok">
                <div class="info-label">Abonado</div>
                <div class="info-value" id="sumAbonado">$ 0,00</div>
            </div>
        </div>
        <div class="col-6 col-md-4">
            <div class="info-box info-warn">
                <div class="info-label">Saldo</div>
                <div class="info-value" id="sumSaldo">$ 0,00</div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- IZQUIERDA -->
        <div class="col-xl-7">
            <!-- Datos / Período -->
            <div class="card glass">
                <div class="card-header sticky">
                    <i class="bi bi-calendar3-range me-2"></i> Datos / Período
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-12">
                            <label class="form-label">Tipo de comisión</label>
                            <div class="segmented" id="segTipo" role="tablist" aria-label="Tipo de comisión">
                                <button class="segment active" data-tipo="0" role="tab" aria-selected="true">
                                    <i class="bi bi-intersect me-1"></i>Ambos
                                </button>
                                <button class="segment" data-tipo="1" role="tab" aria-selected="false">
                                    <i class="bi bi-graph-up-arrow me-1"></i>Ventas
                                </button>
                                <button class="segment" data-tipo="2" role="tab" aria-selected="false">
                                    <i class="bi bi-cash-coin me-1"></i>Cobros
                                </button>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Tipo de Negocio</label>
                            <select id="slcTipoNegocio" class="form-select">
                                <option value="-1">Todos</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Vendedor</label>
                            <select id="slcUsuario" class="form-select">
                                <option value="">Seleccionar</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Desde</label>
                            <div class="input-icon">
                                <i class="bi bi-calendar3"></i>
                                <input type="date" id="inpDesde" class="form-control" inputmode="numeric">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hasta</label>
                            <div class="input-icon">
                                <i class="bi bi-calendar3"></i>
                                <input type="date" id="inpHasta" class="form-control" inputmode="numeric">
                            </div>
                        </div>

                        <div class="col-12 d-flex flex-wrap gap-2">
                            <button class="btn btn-info" id="btnCalcular">
                                <i class="bi bi-cpu me-1"></i>Calcular
                            </button>
                            <input type="text" id="inpConcepto" class="form-control flex-grow-1" placeholder="Concepto (p.ej. Liquidación semanal)" maxlength="120">
                            <input type="text" id="inpNota" class="form-control flex-grow-1" placeholder="Nota / Observaciones" maxlength="200">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalle -->
            <div class="card glass mt-3">
                <div class="card-header sticky">
                    <i class="bi bi-list-check me-2"></i> Detalle de Comisión
                </div>
                <div class="card-body p-0">
                    <div class="table-wrap">
                        <table class="table table-dark table-hover align-middle mb-0" id="tblDetalle">
                            <thead>
                                <tr>
                                    <th style="min-width:320px">Descripción</th>
                                    <th class="text-end">Base</th>
                                    <th class="text-end">% </th>
                                    <th class="text-end">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="4" class="text-center text-muted py-5">
                                        <div class="empty">
                                            <i class="bi bi-ui-checks-grid"></i>
                                            <div class="empty-title">Sin detalle</div>
                                            <div class="empty-sub">Calculá para ver los ítems de comisión</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="d-none" id="tfootDetalle">
                                <tr>
                                    <th class="text-end pe-3">Totales</th>

                                    <th></th>
                                    <th></th>
                                    <th class="text-end money" id="ftImporte">—</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- DERECHA -->
        <div class="col-xl-5">
            <div class="card glass h-100">
                <div class="card-header sticky">
                    <i class="bi bi-speedometer2 me-2"></i> Resumen
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="pill">
                                <i class="bi bi-graph-up-arrow"></i>
                                <span>Comisión por Ventas</span>
                                <strong id="sumVentas">$ 0,00</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="pill">
                                <i class="bi bi-cash-coin"></i>
                                <span>Comisión por Cobros</span>
                                <strong id="sumCobros">$ 0,00</strong>
                            </div>
                        </div>
                    </div>

                    <hr class="divider">

                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h6 class="text-muted m-0"><i class="bi bi-receipt-cutoff me-1"></i>Pagos Registrados</h6>
                        <span class="hint">Listado de pagos del período</span>
                    </div>

                    <div class="table-wrap small-wrap">
                        <table class="table table-dark table-sm align-middle" id="tblPagos">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Método</th>
                                    <th class="text-end">Importe</th>
                                    <th>Nota</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="empty-row">
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <div class="empty">
                                            <i class="bi bi-wallet2"></i>
                                            <div class="empty-title">Sin pagos</div>
                                            <div class="empty-sub">Registrá un pago para verlo aquí</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- BOTÓN: Agregar Pago (debajo de la tabla de pagos) -->
                    <div class="d-flex justify-content-end mt-2">
                        <button id="btnOpenPago" class="btn btn-info">
                            <i class="bi bi-plus-circle me-1"></i>Agregar Pago
                        </button>
                    </div>

                    <!-- Firma del período -->
                    <div class="card glass mt-3">
                        <div class="card-header"><i class="bi bi-file-earmark-text me-2"></i> Comprobante / Firma del período</div>
                        <div class="card-body">
                            <label class="form-label">Adjuntar PDF o imagen firmada</label>
                            <label class="file-input w-100" id="firmaWrapper">
                                <input type="file" id="firmaFile" accept="image/*,.pdf">
                                <span class="fake">
                                    <i class="bi bi-paperclip"></i>
                                    <span class="txt">Seleccionar archivo</span>
                                    <span class="name" id="firmaName">Ningún archivo seleccionado</span>
                                </span>
                            </label>
                            <div class="tiny text-muted mt-2">Este archivo se adjunta al período completo.</div>

                            <div class="d-none mt-3" id="firmaPreviewWrap">
                                <div class="preview">
                                    <img id="firmaPreviewImg" alt="Vista previa" />
                                </div>
                                <a id="comprobanteLink" class="btn btn-outline-light btn-sm d-none" target="_blank">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>Abrir comprobante
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- BOTÓN FINAL -->
    <div class="mt-4 d-flex justify-content-end">
        <button id="btnRegistrarTodo" class="btn btn-primary btn-lg">
            <i class="bi bi-check2-circle me-1"></i><span class="txt">Registrar</span>
        </button>
    </div>
</div>

<!-- MODAL: Registrar Pago -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
        <div class="modal-content modal-glass">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Registrar Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="pgFecha" class="form-control" inputmode="numeric">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Método</label>
                        <select id="pgMetodo" class="form-select">
                            <option value="EFECTIVO">Efectivo</option>
                            <option value="TRANSFERENCIA">Transferencia</option>
                            <option value="DEPOSITO">Depósito</option>
                            <option value="MERCADOPAGO">MercadoPago</option>
                            <option value="OTROS">Otros</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Importe</label>
                        <div class="input-icon">
                            <i class="bi bi-currency-dollar"></i>
                            <input type="text" id="pgImporte" class="form-control money-input" placeholder="0,00" inputmode="decimal" autocomplete="off">
                        </div>
                        <div class="tiny text-muted mt-1">Saldo actual: <b id="pgSaldo">$ 0,00</b></div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nota</label>
                        <input type="text" id="pgNota" class="form-control" placeholder="Detalle del pago…">
                    </div>
                </div>
            </div>
            <div class="modal-footer gap-2">
                <button class="btn btn-ghost" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnRegistrarPago" class="btn btn-primary">
                    <i class="bi bi-check2-circle me-1"></i>Registrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Reglas -->
<div class="modal fade" id="modalReglas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
        <div class="modal-content modal-glass modal-reglas">
            <div class="modal-header reglas-head">
                <div class="d-flex align-items-start flex-column">
                    <h5 class="modal-title d-flex align-items-center gap-2">
                        <i class="bi bi-sliders"></i>
                        Reglas de Comisión
                    </h5>
                    <div class="head-sub tiny text-muted">Definí los tramos y porcentajes por Ventas/Cobros</div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <!-- Toolbar -->
                <div class="rule-toolbar glass mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-4">
                            <label class="form-label m-0">Tipo de comisión</label>
                            <div class="segmented mt-1" id="segReglaTipo" role="tablist" aria-label="Tipo de comisión para reglas">
                                <button class="segment active" data-tipo="1" role="tab" aria-selected="true">
                                    <i class="bi bi-graph-up-arrow me-1"></i>Ventas
                                </button>
                                <button class="segment" data-tipo="2" role="tab" aria-selected="false">
                                    <i class="bi bi-cash-coin me-1"></i>Cobros
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label m-0">Tipo de Negocio</label>
                            <select id="rgTipoNegocio" class="form-select mt-1">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="col-lg-4 d-flex align-items-end justify-content-end">
                            <button id="btnNuevaRegla" class="btn btn-success btn-lift">
                                <i class="bi bi-plus-lg me-1"></i>Nueva Regla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla -->
                <div class="table-wrap mt-2 table-wrap-rules">
                    <table class="table table-dark table-hover align-middle table-rules" id="tblReglas">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Tipo Negocio</th>
                                <th class="text-end">Desde</th>
                                <th class="text-end">Hasta</th>
                                <th class="text-end">% Comisión</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody><!-- render JS --></tbody>
                    </table>
                </div>

                <!-- Editor -->
                <div id="reglaEditor" class="rule-editor d-none">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Monto desde</label>
                            <div class="input-icon">
                                <i class="bi bi-currency-dollar"></i>
                                <input type="text" id="edDesde" class="form-control money-input" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Monto hasta</label>
                            <div class="input-icon">
                                <i class="bi bi-currency-dollar"></i>
                                <input type="text" id="edHasta" class="form-control money-input" placeholder="0 (ilimitado)" inputmode="decimal">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">% Comisión</label>
                            <div class="input-icon">
                                <i class="bi bi-percent"></i>
                                <input type="text" id="edPorc" class="form-control" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                        <div class="col-md-3 d-flex align-items-center gap-2">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="edActiva" checked>
                                <label class="form-check-label" for="edActiva">Activa</label>
                            </div>
                            <button id="btnGuardarRegla" class="btn btn-primary ms-3">Guardar</button>
                            @*<button id="btnGuardarRegla" class="btn btn-primary ms-auto btn-lift">
                                <i class="bi bi-save2 m"></i>Guardar
                            </button>*@
                            <button id="btnCancelarRegla" class="btn btn-ghost">Cancelar</button>
                        </div>
                    </div>
                    <div class="small text-muted mt-2">
                        Las reglas se aplican por <b>tramos</b> sobre el <b>monto final</b> del ítem (venta o cobro)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lightbox -->
<div id="imgLightbox">
    <span class="close">&times;</span>
    <img id="imgLightboxImg" src="" alt="Vista ampliada" />
</div>

<script src="~/Scripts/jquery-3.4.1.min.js"></script>
<script src="~/Scripts/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

@section scripts{
    <script>window.PAGOS_ID_SUELDO = @(id.HasValue ? id.Value : 0);</script>
    <script src="~/JavaScript/pagosnuevomodif.js?v=3.5"></script>
}
